
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Soluciones Pesadas</title>

    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- LIBRERÃAS EXTERNAS -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f1f5f9; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .loader-spin { border: 4px solid #e2e8f0; border-top: 4px solid #2563eb; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #e2e8f0; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; padding: 14px; border-radius: 12px; width: 100%; transition: all 0.2s; font-size: 16px; display: flex; justify-content: center; align-items: center; border: none; }
        .btn-primary:active { transform: scale(0.98); background-color: #1d4ed8; }
        .input-field { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: #f8fafc; font-size: 16px; outline: none; }
        .input-field:focus { border-color: #2563eb; background: white; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- PANTALLA DE CARGA (SPLASH SCREEN) CON TU LOGO -->
    <div id="root" class="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-100">
        <div class="text-center flex flex-col items-center animate-fade-in">
            <!-- Referencia al archivo de imagen que subiste a GitHub -->
            <img src="logo_soluciones.jpeg" 
                 alt="Soluciones Pesadas"
                 class="h-auto w-64 object-contain mb-8 mx-auto drop-shadow-md"
                 onerror="this.src='https://via.placeholder.com/300x120?text=Soluciones+Pesadas'">
            
            <div class="loader-spin mb-6"></div>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest animate-pulse">
                Iniciando Sistema de Control
            </p>
        </div>
    </div>

    <script type="text/babel">
        // CONFIGURACIÃ“N FIREBASE (Ya estÃ¡ conectada a tu base de datos)
        const firebaseConfig = {
            apiKey: "AIzaSyAoSYKBpIqwlMY-NhphpnQv8LPYFYLWe2Y",
            authDomain: "sp-consumibles-app.firebaseapp.com",
            projectId: "sp-consumibles-app",
            storageBucket: "sp-consumibles-app.firebasestorage.app",
            messagingSenderId: "581316149994",
            appId: "1:581316149994:web:abefbef557dc0440fbcd93"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

        const Icon = ({ path }) => (
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={path} />
            </svg>
        );

        const paths = {
            dash: "M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z",
            plus: "M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z",
            list: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
            down: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
            back: "M15 19l-7-7 7-7",
            check: "M5 13l4 4L19 7"
        };

        const MASTER_LIST = [
            { id: "1", nombre_consumible: "Oxigeno", unidad_medida_base: "lb" },
            { id: "2", nombre_consumible: "Propano", unidad_medida_base: "lb" },
            { id: "3", nombre_consumible: "Agamix", unidad_medida_base: "mt" },
            { id: "4", nombre_consumible: "ArgÃ³n", unidad_medida_base: "mt" },
            { id: "5", nombre_consumible: "Soldadura 6011", unidad_medida_base: "kg" },
            { id: "6", nombre_consumible: "Soldadura 7018 1/8", unidad_medida_base: "kg" },
            { id: "7", nombre_consumible: "Soldadura MIG ER70S", unidad_medida_base: "kg" },
            { id: "8", nombre_consumible: "Soldadura Niquel 100", unidad_medida_base: "unidad" },
            { id: "9", nombre_consumible: "Discos de corte 7\"", unidad_medida_base: "unidad" },
            { id: "10", nombre_consumible: "Discos de corte 4\"", unidad_medida_base: "unidad" },
            { id: "11", nombre_consumible: "Discos de pulir 7\"", unidad_medida_base: "unidad" },
            { id: "12", nombre_consumible: "Discos de pulir 4\"", unidad_medida_base: "unidad" },
            { id: "13", nombre_consumible: "Discos Flap 4\"", unidad_medida_base: "unidad" },
            { id: "14", nombre_consumible: "Aerosol Alta Temp", unidad_medida_base: "unidad" },
            { id: "15", nombre_consumible: "Varilla Aluminio", unidad_medida_base: "mt" },
            { id: "16", nombre_consumible: "Varilla Inoxidable", unidad_medida_base: "mt" }
        ];

        function App() {
            const [view, setView] = React.useState('home');
            const [user, setUser] = React.useState(null);
            const [data, setData] = React.useState([]);
            const [appReady, setAppReady] = React.useState(false);

            React.useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        firebase.firestore().collection('consumos_diarios')
                            .orderBy('fecha_registro', 'desc').limit(50)
                            .onSnapshot(snap => {
                                setData(snap.docs.map(d => ({id: d.id, ...d.data()})));
                                setTimeout(() => setAppReady(true), 1500);
                            });
                    } else {
                        firebase.auth().signInAnonymously();
                    }
                });
                return () => unsubscribe();
            }, []);

            if (!appReady) return null;

            if (view === 'home') return (
                <div className="max-w-md mx-auto p-6 pt-10 animate-fade-in text-center">
                    <div className="mb-10">
                        <img src="logo_soluciones.jpeg" alt="Logo" className="h-20 mx-auto mb-4 object-contain" onerror="this.style.display='none'"/>
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight uppercase">Soluciones Pesadas</h1>
                        <p className="text-sm font-bold text-slate-400 uppercase tracking-widest">Sistema de Control</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <div className="card p-5 text-center">
                            <span className="text-3xl font-black text-blue-600 block">{data.length}</span>
                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Registros</span>
                        </div>
                        <div className="card p-5 text-center flex flex-col items-center justify-center">
                            <div className="flex items-center gap-2">
                                <span className="h-2 w-2 bg-emerald-500 rounded-full animate-ping"></span>
                                <span className="text-sm font-black text-emerald-600 uppercase">En LÃ­nea</span>
                            </div>
                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter mt-1">Sincronizado</span>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <button onClick={() => setView('add')} className="card p-5 flex items-center gap-5 w-full active:bg-blue-50 transition border-l-4 border-blue-600">
                            <div className="bg-blue-600 p-3 rounded-xl text-white shadow-md"><Icon path={paths.plus}/></div>
                            <div className="text-left"><div className="font-bold text-slate-800">Nuevo Registro</div><div className="text-xs text-slate-400 uppercase">Salida de material</div></div>
                        </button>
                        <button onClick={() => setView('report')} className="card p-5 flex items-center gap-5 w-full active:bg-slate-50 transition border-l-4 border-slate-400">
                            <div className="bg-slate-100 p-3 rounded-xl text-slate-600 shadow-sm"><Icon path={paths.list}/></div>
                            <div className="text-left"><div className="font-bold text-slate-800">Historial</div><div className="text-xs text-slate-400 uppercase">Consultar movimientos</div></div>
                        </button>
                        <button onClick={() => setView('export')} className="card p-5 flex items-center gap-5 w-full active:bg-emerald-50 transition border-l-4 border-emerald-500">
                            <div className="bg-emerald-100 p-3 rounded-xl text-emerald-600 shadow-sm"><Icon path={paths.down}/></div>
                            <div className="text-left"><div className="font-bold text-slate-800">Descargar Excel</div><div className="text-xs text-slate-400 uppercase">Generar Reporte</div></div>
                        </button>
                    </div>
                    <p className="mt-12 text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest">Soluciones Pesadas Â© 2026</p>
                </div>
            );

            if (view === 'add') return <AddScreen setView={setView} user={user} />;
            if (view === 'report') return <ReportScreen setView={setView} data={data} />;
            if (view === 'export') return <ExportScreen setView={setView} data={data} />;
            return null;
        }

        const Header = ({title, setView}) => (
            <div className="flex items-center mb-6">
                <button onClick={() => setView('home')} className="p-3 bg-white rounded-full shadow-sm mr-4 text-slate-600 active:scale-90 transition">
                    <Icon path={paths.back} />
                </button>
                <h2 className="text-xl font-black text-slate-800 tracking-tight">{title}</h2>
            </div>
        );

        const AddScreen = ({setView, user}) => {
            const [form, setForm] = React.useState({ id: "", cant: "", obs: "" });
            const [unit, setUnit] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const handleChange = (e) => {
                const item = MASTER_LIST.find(i => i.id === e.target.value);
                setForm({...form, id: e.target.value});
                setUnit(item ? item.unidad_medida_base : "");
            };
            const save = async (e) => {
                e.preventDefault();
                setLoading(true);
                const item = MASTER_LIST.find(i => i.id === form.id);
                try {
                    await firebase.firestore().collection('consumos_diarios').add({
                        fecha: new Date().toISOString().split('T')[0],
                        consumible_id: item.nombre_consumible,
                        cantidad: Number(form.cant),
                        unidad_medida: unit,
                        observaciones: form.obs || "Sin notas",
                        registrado_por: "Diover",
                        fecha_registro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setView('home');
                } catch(err) { alert("Error guardando: " + err.message); }
                setLoading(false);
            };
            return (
                <div className="max-w-md mx-auto p-6 min-h-screen bg-[#f1f5f9] animate-fade-in">
                    <Header title="Nuevo Registro" setView={setView} />
                    <form onSubmit={save} className="card p-6 space-y-6">
                        <div>
                            <label className="block text-xs font-black text-slate-400 uppercase mb-2">Material / Consumible</label>
                            <select required className="input-field font-bold" value={form.id} onChange={handleChange}>
                                <option value="">Seleccionar material...</option>
                                {MASTER_LIST.map(i => <option key={i.id} value={i.id}>{i.nombre_consumible}</option>)}
                            </select>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="block text-xs font-black text-slate-400 uppercase mb-2">Cantidad</label>
                                <input required type="number" step="0.01" placeholder="0.00" className="input-field font-bold text-blue-600" value={form.cant} onChange={e=>setForm({...form, cant:e.target.value})} />
                            </div>
                            <div className="w-24">
                                <label className="block text-xs font-black text-slate-400 uppercase mb-2">Unidad</label>
                                <input readOnly className="input-field bg-slate-100 text-center font-bold text-slate-400" value={unit || '-'} />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-black text-slate-400 uppercase mb-2">Notas / Observaciones</label>
                            <textarea className="input-field" rows="3" placeholder="Detalles adicionales..." value={form.obs} onChange={e=>setForm({...form, obs:e.target.value})}></textarea>
                        </div>
                        <button disabled={loading} className="btn-primary shadow-lg shadow-blue-200">
                            {loading ? "Procesando..." : "Guardar Registro"}
                        </button>
                    </form>
                </div>
            );
        };

        const ReportScreen = ({setView, data}) => (
            <div className="max-w-md mx-auto p-6 min-h-screen bg-[#f1f5f9] animate-fade-in">
                <Header title="Historial" setView={setView} />
                <div className="card overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b font-bold text-slate-400 text-[10px] uppercase tracking-widest">Ãšltimos Registros del Taller</div>
                    {data.length === 0 ? <div className="p-10 text-center text-slate-300">No hay movimientos registrados</div> :
                    <div className="divide-y divide-slate-100 max-h-[70vh] overflow-y-auto">
                        {data.map(item => (
                            <div key={item.id} className="p-4 flex justify-between items-center bg-white hover:bg-slate-50 transition">
                                <div>
                                    <div className="font-bold text-slate-800">{item.consumible_id}</div>
                                    <div className="text-[10px] font-bold text-slate-300 uppercase mt-1">ðŸ“… {item.fecha}</div>
                                </div>
                                <div className="text-right">
                                    <div className="font-black text-blue-600 text-lg">{item.cantidad}</div>
                                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">{item.unidad_medida}</div>
                                </div>
                            </div>
                        ))}
                    </div>}
                </div>
            </div>
        );

        const ExportScreen = ({setView, data}) => {
            const [month, setMonth] = React.useState(new Date().toISOString().slice(0, 7));
            const download = () => {
                const filtered = data.filter(d => d.fecha && d.fecha.startsWith(month));
                if(filtered.length === 0) return alert("No hay datos para este mes");
                let csv = "\uFEFFFecha,Consumible,Cantidad,Unidad,Registrado Por,Observaciones\n";
                filtered.forEach(d => {
                    csv += `${d.fecha},"${d.consumible_id}",${d.cantidad},${d.unidad_medida},${d.registrado_por},"${(d.observaciones||'').replace(/,/g,' ')}"\n`;
                });
                const link = document.createElement("a");
                link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
                link.download = `Reporte_Soldadura_${month}.csv`;
                link.click();
            };
            return (
                <div className="max-w-md mx-auto p-6 min-h-screen bg-[#f1f5f9] animate-fade-in">
                    <Header title="Exportar Reporte" setView={setView} />
                    <div className="card p-8 space-y-6">
                        <div>
                            <label className="block text-xs font-black text-slate-400 uppercase mb-2">Seleccionar PerÃ­odo</label>
                            <input type="month" className="input-field font-bold text-slate-600" value={month} onChange={e=>setMonth(e.target.value)} />
                        </div>
                        <button onClick={download} className="btn-primary bg-emerald-600 hover:bg-emerald-700 shadow-lg shadow-emerald-100">
                            Generar Excel (.CSV)
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
